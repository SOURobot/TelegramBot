import logging
from telegram.ext import Application, MessageHandler, filters, CommandHandler, ConversationHandler
from telegram import ReplyKeyboardMarkup
from parsing import main_func


BOT_TOKEN = "6291281713:AAHrleKYDcmcciulEkQINb1XQcaSiCFfvcA"

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.DEBUG)
logger = logging.getLogger(__name__)


reply_keyboard = [['/start', '/help'], ['/search', '/stop']]
markup = ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True)

params = {}


async def start(update, context):
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç!\n–ú–µ–Ω—è –∑–æ–≤—É—Ç Cheap & Daily –∏ —è —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç.\n–•–æ—Ç–∏—Ç–µ –≤—ã–±—Ä–∞—Ç—å—Å—è –∏–∑ –ú–æ—Å–∫–≤—ã –∏ –∫—É–¥–∞-–Ω–∏–±—É–¥—å —Å–ª–µ—Ç–∞—Ç—å? –¢–æ–≥–¥–∞ –≤–∞–º –∫–æ –º–Ω–µ! –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ —Å–∞–º—ã–µ –≤—ã–≥–æ–¥–Ω—ã–µ –±–∏–ª–µ—Ç—ã, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–µ –≤–∞—à–∏–º –ø–æ–∂–µ–ª–∞–Ω–∏—è–º.\n–ù—É —á—Ç–æ, –Ω–∞—á–Ω–µ–º?\n–¢–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞–π—Ç–µ /search –∏ –ø–æ–µ—Ö–∞–ª–∏!\nP.S. –ù–µ –∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ —Å–æ –º–Ω–æ–π —Ä–∞–±–æ—Ç–∞—Ç—å? –ù–∞–∂–º–∏—Ç–µ /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ –ø—Ä–æ—á–∏—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.", reply_markup=markup)


async def help(update, context):
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! Cheap Daily ‚Äì —ç—Ç–æ —Ç–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –¥–µ—à–µ–≤—ã—Ö –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤.\n–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞?\n–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—É /search, –¥–∞–ª—å—à–µ –æ—Ç –≤–∞—Å —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –±–æ—Ç –Ω–∞–π–¥—ë—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–æ–π–¥—É—Ç –∏–º–µ–Ω–Ω–æ –≤–∞–º.\n–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É:\n–ü–∞—Ä–∞–º–µ—Ç—Ä ‚Ññ1:\n–°–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å. –í–æ–¥–∏—Ç—å –Ω—É–∂–Ω–æ —Ü–∏—Ñ—Ä—É –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –∏–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤\n–ü–∞—Ä–∞–º–µ—Ç—Ä ‚Ññ2:\n–ñ–µ–ª–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ª–µ—Ç–∞. –í–æ–¥–∏—Ç—å –Ω—É–∂–Ω–æ —Ü–∏—Ñ—Ä—É –ø–µ—Ä–µ–¥, –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å ‚Äú–¥–æ‚Äù –∏–ª–∏ ‚Äú–ø–æ—Å–ª–µ‚Äù\n–ü–∞—Ä–∞–º–µ—Ç—Ä ‚Ññ3:\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞. –í–æ–¥–∏—Ç—å –Ω—É–∂–Ω–æ —Ü–∏—Ñ—Ä—É –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –∏–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤\n–ü–∞—Ä–∞–º–µ—Ç—Ä ‚Ññ4:\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –±–∏–ª–µ—Ç–∞. –ö–∞–∫ –≤ 1-–æ–º –∏ 3-–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–µ, –≤–æ–¥–∏—Ç—å –Ω—É–∂–Ω–æ —Ü–∏—Ñ—Ä—É –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –∏–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤\n\n–£–¥–∞—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Cheap Daily!")


async def search(update, context):
    await update.message.reply_text("–ù–∞–∂–º–∏—Ç–µ /tips –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ –ø–æ–∏—Å–∫—É\n–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ /go –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.")


async def tips(update, context):
    await update.message.reply_text("""‚ö† –í —ç—Ç–æ–º –±–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è –≥–∏–±–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –Ω–∏–∂–µ.\n
                                    """)


async def go(update, context):
    global params
    params = {}
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç üèõ\n–ü—Ä–∏–º–µ—Ä: –í–Ω—É–∫–æ–≤–æ")
    #check
    return 1


async def first_r(update, context):
    params["airport"] = update.message.text
    await update.message.reply_text("–°–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å? üìã\n–ü—Ä–∏–º–µ—Ä: 5")
    #check
    return 2


async def second_r(update, context):
    params["amount"] = int(update.message.text)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –≤—ã–ª–µ—Ç–∞ üï§\n–ü—Ä–∏–º–µ—Ä: –ø–æ—Å–ª–µ 18")
    # check
    return 3


async def third_r(update, context):
    params["time"] = update.message.text
    await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–ª–µ—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö ‚è≥\n–ü—Ä–∏–º–µ—Ä: 180")
    # check
    return 4


async def fourth_r(update, context):
    params["duration"] = update.message.text
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω–∞ –±–∏–ª–µ—Ç–∞ –≤ —Ä—É–±–ª—è—Ö üíµ\n–ü—Ä–∏–º–µ—Ä: 3000")
    # check
    return 5


async def fifth_r(update, context):
    params["cost"] = update.message.text
    await update.message.reply_text(f"‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ üëá\n\n–ê—ç—Ä–æ–ø–æ—Ä—Ç üèõ: {params['airport']}\n–ë—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: {params['amount']}\n–í—Ä–µ–º—è –≤—ã–ª–µ—Ç–∞ üï§: {params['time']}\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚è≥: –¥–æ {params['duration']}\n–¶–µ–Ω–∞ –±–∏–ª–µ—Ç–æ–≤ üíµ: –¥–æ {params['cost']}\n\n–ï—Å–ª–∏ –≤—Å–µ –≤–µ—Ä–Ω–æ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
    # add buttons
    return 6


async def sixth_r(update, context):
    x = update.message.text
    output = main_func(params)
    await update.message.reply_text(str(output))
    return ConversationHandler.END


async def stop(update, context):
    await update.message.reply_text("–ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω ‚ùå")
    return ConversationHandler.END


def main():
    app = Application.builder().token(token=BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help))
    app.add_handler(CommandHandler("search", search))
    app.add_handler(CommandHandler("tips", tips))

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('go', go)],
        states={
            1: [MessageHandler(filters.TEXT & ~filters.COMMAND, first_r)],
            2: [MessageHandler(filters.TEXT & ~filters.COMMAND, second_r)],
            3: [MessageHandler(filters.TEXT & ~filters.COMMAND, third_r)],
            4: [MessageHandler(filters.TEXT & ~filters.COMMAND, fourth_r)],
            5: [MessageHandler(filters.TEXT & ~filters.COMMAND, fifth_r)],
            6: [MessageHandler(filters.TEXT & ~filters.COMMAND, sixth_r)]
        },
        fallbacks=[CommandHandler('stop', stop)])

    app.add_handler(conv_handler)
    app.run_polling()


if __name__ == "__main__":
    main()